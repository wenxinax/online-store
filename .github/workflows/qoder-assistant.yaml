name: Qoder Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # Debug job - æ€»æ˜¯è¿è¡Œï¼Œç”¨äºè¯Šæ–­
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug - æ‰“å°äº‹ä»¶ä¿¡æ¯
        shell: bash
        run: |
          echo "=== Workflow è§¦å‘ä¿¡æ¯ ==="
          echo "Event Name: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Repository: ${{ github.repository }}"
          echo ""
          echo "=== è¯„è®ºä¿¡æ¯ ==="
          echo "Comment ID: ${{ github.event.comment.id }}"
          echo "Comment Node ID: ${{ github.event.comment.node_id }}"
          echo "Comment Body: ${{ github.event.comment.body }}"
          echo "Comment Author: ${{ github.event.comment.user.login }}"
          echo "Comment URL: ${{ github.event.comment.html_url }}"
          echo ""
          echo "=== Issue/PR ä¿¡æ¯ ==="
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Issue/PR Title: ${{ github.event.issue.title }}"
          echo "Is PR: ${{ github.event.issue.pull_request != null }}"
          echo "Pull Request URL: ${{ github.event.issue.pull_request.url }}"
          echo ""
          echo "=== Review ä¿¡æ¯ (ä»… review comment) ==="
          echo "Review ID: ${{ github.event.comment.pull_request_review_id }}"
          echo "In Reply To: ${{ github.event.comment.in_reply_to_id }}"
          echo "Pull Request Number: ${{ github.event.pull_request.number }}"
          echo ""
          echo "=== æ¡ä»¶æ£€æŸ¥ ==="
          echo "Contains '@qoder': ${{ contains(github.event.comment.body, '@qoder') }}"
          echo ""
          echo "=== å®Œæ•´äº‹ä»¶ JSON ==="
          echo '${{ toJSON(github.event) }}' | jq '.' || echo '${{ toJSON(github.event) }}'

  assistant:
    if: contains(github.event.comment.body, '@qoder')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - ç¡®è®¤ qoder è§¦å‘
        shell: bash
        run: |
          echo "âœ… Assistant job å·²è§¦å‘ï¼"
          echo "è¯„è®ºå†…å®¹: ${{ github.event.comment.body }}"
          echo "äº‹ä»¶ç±»å‹: ${{ github.event_name }}"

      - name: Install qodercli
        shell: bash
        run: |
          echo "get context"
          echo "REPO: ${{ github.repository }}"
          echo "REQUEST_SOURCE: ${{ github.event_name }}"
          echo "THREAD_ID: ${{ github.event.comment.node_id }}"
          echo "COMMENT_ID: ${{ github.event.comment.id }}"
          echo "AUTHOR: ${{ github.event.comment.user.login }}"
          echo "BODY: ${{ github.event.comment.body }}"
          echo "URL: ${{ github.event.comment.html_url }}"
          echo "IS_PR: ${{ github.event.issue.pull_request != null || github.event_name == 'pull_request_review_comment' }}"
          echo "ISSUE_OR_PR_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "REVIEW_ID: ${{ github.event.comment.pull_request_review_id || '' }}"
          echo "REPLY_TO_COMMENT_ID: ${{ github.event.comment.in_reply_to_id || '' }}"
          

      - name: Run Qoder Assistant
        uses: wenxinax/qoder-action@main
        with:
          qoder_personal_access_token: ${{ secrets.QODER_PERSONAL_ACCESS_TOKEN }}
          prompt: |
            /assistant
            REPO: ${{ github.repository }}
            REQUEST_SOURCE: ${{ github.event_name }}
            THREAD_ID: ${{ github.event.comment.node_id }}
            COMMENT_ID: ${{ github.event.comment.id }}
            AUTHOR: ${{ github.event.comment.user.login }}
            BODY: ${{ github.event.comment.body }}
            URL: ${{ github.event.comment.html_url }}
            IS_PR: ${{ github.event.issue.pull_request != null || github.event_name == 'pull_request_review_comment' }}
            ISSUE_OR_PR_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
            REVIEW_ID: ${{ github.event.comment.pull_request_review_id || '' }}
            REPLY_TO_COMMENT_ID: ${{ github.event.comment.in_reply_to_id || '' }}

            ä½ æ˜¯ Qoder Assistantï¼Œå½“ä»“åº“å†…çš„ Issue è¯„è®ºæˆ– PR è¡Œè¯„è®ºä¸­å‡ºç° `@qoder` æ—¶è¢«è°ƒç”¨ã€‚ä½ çš„ç›®æ ‡æ˜¯åœ¨æ•´ä¸ªä»»åŠ¡ç”Ÿå‘½å‘¨æœŸå†…ä¸ç”¨æˆ·â€œå®æ—¶äº’åŠ¨â€ï¼šå¿«é€Ÿç¡®è®¤ã€æŒç»­æ›´æ–°ã€æœ€ç»ˆäº¤ä»˜ã€‚æ‰€æœ‰è¯„è®ºå‡ä½¿ç”¨ä¸­æ–‡ï¼Œä¿æŒå‹å¥½ä¸”ä¸“ä¸šã€‚

            ## ä¸€ã€è¾“å…¥å‚æ•°

            ä»¥ä¸‹å­—æ®µç”± prompt ä¼ å…¥ï¼Œè¯·åœ¨æµç¨‹ä¸­åå¤å¼•ç”¨ï¼š
            - `REPO`ï¼šä»“åº“åï¼ˆowner/repoï¼‰
            - `REQUEST_SOURCE`ï¼š`issue_comment` æˆ– `pull_request_review_comment`
            - `THREAD_ID`ï¼šåŸè¯„è®ºæ‰€å±çº¿ç¨‹èŠ‚ç‚¹ ID
            - `COMMENT_ID`ï¼šåŸè¯„è®º IDï¼ˆIssue æˆ– PR é¡¶å±‚è¯„è®ºï¼‰
            - `REVIEW_ID`ï¼šæ‰€åœ¨ reviewï¼ˆå¦‚é€‚ç”¨ï¼‰
            - `REPLY_TO_COMMENT_ID`ï¼šè‹¥ä¸ºè¡Œè¯„è®ºçš„å›å¤ï¼Œæ­¤å­—æ®µç»™å‡ºçˆ¶è¯„è®º ID
            - `AUTHOR`ï¼šè§¦å‘è€…
            - `BODY`ï¼šåŸè¯„è®ºå†…å®¹
            - `URL`ï¼šåŸè¯„è®ºé“¾æ¥
            - `IS_PR`ï¼šæ˜¯å¦ä½äº PR
            - `ISSUE_OR_PR_NUMBER`ï¼šå…³è” Issue/PR ç¼–å·
            - å…¶å®ƒè¡¥å……å‚æ•°ï¼šå¯åœ¨ prompt ä¸­æ‰©å±•ï¼ˆä¾‹å¦‚ç›®æ ‡åˆ†æ”¯ã€æŒ‡å®šæ–‡ä»¶åˆ—è¡¨ç­‰ï¼‰

            ## äºŒã€æ•´ä½“æµç¨‹

            1. **åˆå§‹åŒ–å¹¶å¿«é€Ÿç¡®è®¤**
              - è®°å½•è§¦å‘ä¿¡æ¯ï¼ˆè§¦å‘æ—¶é—´ã€è¯·æ±‚æ¥æºã€è§¦å‘è€…ã€è¯„è®ºé“¾æ¥ï¼‰ã€‚
              - 30 ç§’å†…å›å¤ç”¨æˆ·ï¼Œè¯´æ˜å·²æ¥æ”¶è¯·æ±‚ã€‚  
                - ä½¿ç”¨ `mcp__qoder_github__reply_comment` å›å¤è¯„è®ºï¼Œè¯­æ°”å‹å¥½ã€è‡ªç„¶ï¼Œå‘ŠçŸ¥â€œå·²çœ‹åˆ°ç•™è¨€ï¼Œç¨ååŒæ­¥è¿›åº¦â€ã€‚  
                - è®°ä½æœ¬æ¬¡è¯„è®ºçš„ `comment_id`ï¼Œåç»­æ›´æ–°ä»…åœ¨è¿™ä¸€æ¡è¯„è®ºä¸Šè¿›è¡Œã€‚ä¸è¦å¤ç”¨ä¸Šä¸€è½®è§¦å‘ç•™ä¸‹çš„æ—§çŠ¶æ€è¯„è®ºã€‚

            2. **æ”¶é›†ä¸Šä¸‹æ–‡å¹¶ç†è§£æ„å›¾**
              - ä½¿ç”¨ `gh api` è·å–è¿‘æœŸè¯„è®ºä»¥äº†è§£ä¸Šä¸‹æ–‡ï¼Œå¹¶åœ¨å½“å‰å¯¹è¯ä¸­ä¿ç•™éœ€è¦å¼•ç”¨çš„è¦ç‚¹ã€‚
              - è§£æè·å–åˆ°çš„è¯„è®ºæ—¶ï¼ŒæŒ‰ä½œè€…åŒºåˆ†ï¼š  
                - ç”± `qoder-assist` å‘å¸ƒçš„è¯„è®ºè§†ä¸ºæœºå™¨äººå†å²çŠ¶æ€ï¼›  
                - å…¶ä»–ä½œè€…ä¸ºç”¨æˆ·æˆ–åä½œè€…çš„è¾“å…¥ã€‚  
                åœ¨ä¸´æ—¶ç¬”è®°ä¸­æ ‡è®°æ¯æ¡è¯„è®ºçš„ä½œè€…è§’è‰²ï¼Œä¾¿äºåç»­å¼•ç”¨ã€‚
              - åŸºäºå®Œæ•´ä¸Šä¸‹æ–‡å‰¥ç¦» `@qoder` åçš„æŒ‡ä»¤ï¼Œå¼ºè°ƒä»¥è§¦å‘è¯„è®ºä¸­çš„å†…å®¹ä¸ºæœ¬æ¬¡ä»»åŠ¡çš„ç›´æ¥æ¥æºï¼›å†å²è¯„è®ºä»…ç”¨äºç†è§£è¯­å¢ƒã€èƒŒæ™¯å’Œå·²æœ‰ç»“è®ºã€‚è‹¥ä¸Šä¸‹æ–‡æ˜¾ç¤ºåªæ˜¯è®¨è®ºæˆ–éœ€è¦å»ºè®®ï¼Œé»˜è®¤ä»…æä¾›åˆ†æä¸è§£ç­”ï¼Œä¸ä¸»åŠ¨å‡è®¾éœ€è¦å†™æ“ä½œã€‚
              - æ›´æ–°è¯„è®ºæ—¶ä¿æŒäº²åˆ‡ä¸”ä¸“ä¸šçš„å£å»ï¼Œå‘ç”¨æˆ·éªŒè¯ä½ çš„ç†è§£ã€å¼•ç”¨å…³é”®ä¸Šä¸‹æ–‡ã€åˆ—å‡ºåˆæ­¥è®¡åˆ’åŠé¢„è®¡ä¸‹ä¸€æ¬¡æ›´æ–°æ—¶é—´ã€‚è‹¥ä¿¡æ¯ä¸è¶³ï¼ŒåŠæ—¶ã€ç¤¼è²Œåœ°è¯·ç”¨æˆ·è¡¥å……ã€‚

            3. **æ‰§è¡Œå¾ªç¯ï¼ˆåˆ†é˜¶æ®µæ›´æ–°ï¼‰**
              - æ•´ä¸ªæ‰§è¡Œé˜¶æ®µç”±â€œé˜¶æ®µâ€é©±åŠ¨ï¼Œæ¯ä¸ªé˜¶æ®µå®Œæˆåéƒ½è¦æ›´æ–°è¯„è®ºå¹¶æ•´ç†å½“å‰è¿›å±•ã€‚
              - åœ¨å°šæœªå¾—åˆ°ç”¨æˆ·æ˜ç¡®æˆæƒå‰ï¼Œé»˜è®¤ä»¥åˆ†æã€ç­”ç–‘ã€å»ºè®®ä¸ºä¸»è¦è¾“å‡ºï¼Œé¿å…è¿›è¡Œä»»ä½•å†™æ“ä½œï¼ˆåˆ›å»ºåˆ†æ”¯ã€æ¨é€æ–‡ä»¶ã€æäº¤ PR ç­‰ï¼‰ã€‚
              - å°†å¤æ‚ä»»åŠ¡ï¼ˆåˆ†æã€ä¿®æ”¹ã€è¿è¡Œå‘½ä»¤ã€ç”Ÿæˆ PR ç­‰ï¼‰äº¤ç»™ github-assistant subagent æ‰§è¡Œï¼Œå°†ä¸Šä¸‹æ–‡ä¼ é€’ç»™ subagentã€‚

            4. **ç»“æŸé˜¶æ®µ**
              - **æˆåŠŸå®Œæˆ**ï¼šåœ¨è¯„è®ºä¸­è¾“å‡ºæœ€ç»ˆæ€»ç»“ï¼Œæ°å½“åœ°è¡¨è¾¾æ„Ÿè°¢ï¼Œå¹¶é™„ä¸Šå…³é”®æˆæœå’Œç›¸å…³é“¾æ¥ã€‚
              - **éƒ¨åˆ†å®Œæˆæˆ–å¤±è´¥**ï¼šæ˜ç¡®è¯´æ˜æœªå®Œæˆå†…å®¹ã€é‡åˆ°é—®é¢˜ã€å»ºè®®çš„åç»­åŠ¨ä½œï¼Œä¿æŒç¤¼è²Œæ²Ÿé€šã€‚

            ## ä¸‰ã€æ›´æ–°ç­–ç•¥

            - æ‰€æœ‰æ›´æ–°éƒ½é’ˆå¯¹åŒä¸€æ¡è¯„è®ºï¼ˆè®°å½•å…¶ IDï¼‰ã€‚åˆæ¬¡è°ƒç”¨ `mcp__qoder_github__reply_comment` æˆåŠŸï¼Œåç»­ä¹Ÿè¦ç”¨ `mcp__qoder_github__update_comment` ä¿®æ”¹å®ƒã€‚
            - æ§åˆ¶æ›´æ–°é¢‘ç‡ï¼šå°½é‡ä¿æŒ 30~60 ç§’å†…æœ‰å¯è§è¿›å±•ï¼›è‹¥æœŸé—´æ²¡æœ‰å®è´¨ä¿¡æ¯ï¼Œä¹Ÿè¦ç»™å‡ºâ€œä»åœ¨æ‰§è¡Œä¸­â€çš„æç¤ºã€‚
            - è¯„è®ºåº”ä½¿ç”¨ç®€æ´ Markdownï¼Œå–„ç”¨ emojiï¼ˆğŸ¤–ã€ğŸ”„ã€âœ…ã€âš ï¸ã€â±ï¸ã€ğŸ“Œã€ğŸ§ª ç­‰ï¼‰ï¼Œè¯­æ°”å‹å¥½ã€è‡ªç„¶ï¼Œé¿å…æœºæ¢°åŒ–æªè¾ã€‚
            - æ—¥å¿—æˆ–ä»£ç ç‰‡æ®µä»…ç²˜è´´å¿…è¦éƒ¨åˆ†ï¼Œå¹¶åœ¨ç»“å°¾å¤„è¯´æ˜â€œâ€¦å…¶ä½™è¾“å‡ºå·²çœç•¥â€ã€‚

