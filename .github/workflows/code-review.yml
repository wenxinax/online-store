name: Automated Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  code-review-job:
    name: Run Code Review
    runs-on: ubuntu-latest

    # èµ‹äºˆ Action æƒé™ï¼Œä»¥ä¾¿å¯ä»¥è¯»å–ä»£ç å’Œåœ¨ PR ä¸­å‘è¡¨è¯„è®º
    permissions:
      contents: read
      pull-requests: write

    steps:
      # æ­¥éª¤ 1: æ‹‰å– PR åˆ†æ”¯çš„æœ€æ–°ä»£ç 
      - name: æ‹‰å–ä»£ç  (Checkout Code)
        uses: actions/checkout@v4
      
      # åœ¨è¿è¡Œè¯„å®¡å·¥å…·å‰ï¼Œå®‰è£…å®ƒæ‰€éœ€è¦çš„ ripgrep å’Œ fzf
      - name: å®‰è£…ä¾èµ– (Install Dependencies)
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep fzf
          echo "ä¾èµ– ripgrep å’Œ fzf å®‰è£…å®Œæ¯•ã€‚"

      # æ­¥éª¤ 2: ä¸‹è½½å¹¶è®¾ç½®è¯„å®¡å·¥å…·
      # ä» Secrets ä¸­è·å–ä¿å¯†çš„ä¸‹è½½é“¾æ¥ï¼Œä¸‹è½½å·¥å…·å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
      - name: ä¸‹è½½å¹¶è®¾ç½®è¯„å®¡å·¥å…· (Download & Setup CLI)
        run: |
          echo "æ­£åœ¨ä¸‹è½½CLIå·¥å…·..."
          wget -O opencode "${{ secrets.OPENCODE_DOWNLOAD_URL }}"
          chmod +x opencode
          echo "CLIå·¥å…·å‡†å¤‡å°±ç»ªã€‚"

      # æ­¥éª¤ 3: è¿è¡Œä»£ç è¯„å®¡å¹¶æ•è·ç»“æœ
      # - ä½¿ç”¨ env å°† API Key å®‰å…¨åœ°è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
      # - è¿è¡Œä½ æŒ‡å®šçš„å‘½ä»¤ï¼Œå¹¶å°†PRå·åŠ¨æ€ä¼ å…¥
      # - å°†æ‰€æœ‰è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶
      # - ä»æ—¥å¿—æ–‡ä»¶ä¸­æå–æœ€åä¸€è¡ŒJSONï¼Œå¹¶ä½¿ç”¨jqè§£æå‡ºè¯„å®¡æ„è§
      # - å°†è§£æå‡ºçš„å¤šè¡Œè¯„å®¡æ„è§å®‰å…¨åœ°å­˜å…¥ GITHUB_OUTPUTï¼Œä»¥ä¾›åç»­æ­¥éª¤ä½¿ç”¨
      - name: è¿è¡Œä»£ç è¯„å®¡ (Run AI Review)
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "æ­£åœ¨æ‰§è¡Œä»£ç è¯„å®¡..."

          # ======================== æ ¸å¿ƒä¿®æ”¹ ========================
          # ä½¿ç”¨ 'script' å‘½ä»¤æ¥æ¨¡æ‹Ÿä¸€ä¸ªäº¤äº’å¼ç»ˆç«¯(TTY)ç¯å¢ƒ
          # è¿™å°†å¼ºåˆ¶ opencode ä½¿ç”¨å…¶åœ¨æœ¬åœ°ç»ˆç«¯æ—¶çš„è¾“å‡ºè¡Œä¸º
          # -q: å®‰é™æ¨¡å¼ï¼Œä¸è¾“å‡º script è‡ªå·±çš„å¯åŠ¨/ç»“æŸä¿¡æ¯
          # -c "command": åœ¨æ¨¡æ‹Ÿç»ˆç«¯å†…æ‰§è¡Œçš„å‘½ä»¤
          # review_output.log: æ•è·æ¨¡æ‹Ÿç»ˆç«¯ä¸­çš„æ‰€æœ‰è¾“å‡ºåˆ°æ­¤æ–‡ä»¶
          script -q -c "./opencode -c ${{ github.workspace }} -d -a reviewer -p 'review ${{ github.event.pull_request.number }}'" review_output.log
          EXIT_CODE=$?
          # ==========================================================
          
          echo "å‘½ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œé€€å‡ºç ä¸º: $EXIT_CODE"

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::è¯„å®¡å·¥å…·æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç ä¸º $EXIT_CODEã€‚"
          fi
          
          echo "--- review_output.log æ–‡ä»¶å†…å®¹å¦‚ä¸‹ ---"
          cat review_output.log
          echo "--- æ–‡ä»¶å†…å®¹ç»“æŸ ---"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s review_output.log ]; then
            echo "::error::review_output.log æ–‡ä»¶ä¸ºç©ºï¼Œè¯„å®¡å·¥å…·æ²¡æœ‰äº§ç”Ÿä»»ä½•è¾“å‡ºã€‚"
            echo 'comment_body=âŒ AIè¯„å®¡å¤±è´¥ï¼šCLIå·¥å…·æ‰§è¡ŒæˆåŠŸä½†æ²¡æœ‰äº§ç”Ÿä»»ä½•è¾“å‡ºã€‚è¯·æ£€æŸ¥Actionæ—¥å¿—ã€‚' >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "æ­£åœ¨è§£æè¯„å®¡ç»“æœ..."
          # è§£æé€»è¾‘ä¿æŒä¸å˜ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨æœŸæœ› review_output.log çš„å†…å®¹å’Œæœ¬åœ°å®Œå…¨ä¸€è‡´
          REVIEW_COMMENT=$(tail -n 1 review_output.log | jq -r '.message.content[0].text')

          if [ -z "$REVIEW_COMMENT" ] || [ "$REVIEW_COMMENT" == "null" ]; then
            echo "æœªèƒ½ä»CLIè¾“å‡ºä¸­æå–æœ‰æ•ˆçš„è¯„å®¡æ„è§ã€‚è¯·æ£€æŸ¥ä¸Šé¢çš„åŸå§‹è¾“å‡ºä»¥ç¡®å®šé—®é¢˜ã€‚"
            echo 'comment_body<<EOF' >> $GITHUB_OUTPUT
            echo "âŒ AIè¯„å®¡å¤±è´¥" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**é”™è¯¯è¯¦æƒ…:** æœªèƒ½ä»CLIå·¥å…·çš„è¾“å‡ºä¸­è§£æå‡ºè¯„å®¡æ„è§ï¼ˆé€€å‡ºç : $EXIT_CODEï¼‰ã€‚" >> $GITHUB_OUTPUT
            echo "<details><summary>ç‚¹å‡»æŸ¥çœ‹CLIåŸå§‹è¾“å‡º</summary>" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            # æ¸…ç†ä¸€ä¸‹é¢œè‰²ä»£ç ï¼Œä»¥é˜²ä¸‡ä¸€
            sed 's/\x1b\[[0-9;]*m//g' review_output.log >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            echo "</details>" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
          else
            echo "æˆåŠŸè§£æåˆ°è¯„å®¡æ„è§ã€‚"
            echo 'comment_body<<EOF' >> $GITHUB_OUTPUT
            echo "### ğŸ¤– AI ä»£ç è¯„å®¡æ„è§" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
          fi
          
      - name: å°†è¯„å®¡æ„è§å‘å¸ƒåˆ° PR (Post Review Comment to PR)
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.review.outputs.comment_body }}
          edit-mode: replace